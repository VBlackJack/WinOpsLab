---
title: "Azure Arc pour serveurs"
description: Integrer des serveurs on-premises avec Azure Arc - concept, onboarding, Azure Policy et surveillance depuis le portail Azure.
tags:
  - gestion-moderne
  - azure
  - intermediaire
---

# Azure Arc pour serveurs

<span class="level-intermediate">Intermediaire</span> Â· Temps estime : 30 minutes

## Presentation

Azure Arc permet de projeter des serveurs on-premises (ou heberges dans d'autres clouds) dans le plan de gestion Azure. Une fois inscrits, ces serveurs apparaissent dans le portail Azure comme des ressources natives et beneficient des services Azure : policies, monitoring, update management et securite.

```mermaid
graph TD
    A[Serveurs on-premises] -->|Azure Connected Machine Agent| B[Azure Arc]
    C[Serveurs AWS/GCP] -->|Azure Connected Machine Agent| B
    B --> D[Portail Azure]
    D --> E[Azure Policy]
    D --> F[Azure Monitor]
    D --> G[Microsoft Defender for Cloud]
    D --> H[Azure Update Management]
    D --> I[Azure Automation]
```

## Concepts fondamentaux

| Concept | Description |
|---------|-------------|
| **Azure Connected Machine Agent** | Agent installe sur le serveur on-premises qui etablit la connexion avec Azure |
| **Resource Group** | Groupe de ressources Azure contenant les serveurs Arc |
| **Managed Identity** | Identite geree automatiquement pour chaque serveur Arc |
| **Extensions** | Agents supplementaires deployes via Arc (Log Analytics, Defender, etc.) |
| **Azure Policy** | Strategies de conformite appliquees aux serveurs Arc |

## Prerequis

### Prerequis Azure

| Element | Requis |
|---------|--------|
| Abonnement Azure | Actif avec un Resource Group |
| Role RBAC | **Azure Connected Machine Onboarding** (minimum) |
| Resource Provider | `Microsoft.HybridCompute` et `Microsoft.GuestConfiguration` enregistres |

### Prerequis sur le serveur

| Element | Requis |
|---------|--------|
| OS | Windows Server 2012 R2+ ou Linux supporte |
| Connectivite | HTTPS (port 443) vers les endpoints Azure |
| PowerShell | Version 4.0+ |
| .NET Framework | 4.6+ |

### Endpoints reseau requis

| Endpoint | Usage |
|----------|-------|
| `management.azure.com` | Azure Resource Manager |
| `login.microsoftonline.com` | Authentification Azure AD |
| `guestnotificationservice.azure.com` | Service de notification |
| `*.his.arc.azure.com` | Service d'identite hybride |
| `*.guestconfiguration.azure.com` | Guest Configuration |
| `dc.services.visualstudio.com` | Telemetrie Application Insights |

## Inscrire un serveur (onboarding)

### Methode interactive (un serveur)

1. Dans le portail Azure, rechercher **Azure Arc** > **Serveurs** > **Ajouter**
2. Selectionner **Ajouter un seul serveur**
3. Configurer : abonnement, resource group, region, OS
4. Telecharger le script genere
5. Executer le script sur le serveur on-premises

```powershell
# Download and run the onboarding script (generated by the portal)
# The script installs the agent and registers the server

# Manual agent download
Invoke-WebRequest -Uri "https://aka.ms/azcmagent-windows" `
    -OutFile "C:\Temp\AzureConnectedMachineAgent.msi"

# Install the agent
msiexec /i "C:\Temp\AzureConnectedMachineAgent.msi" /l*v "C:\Temp\azcmagent-install.log" /qn

# Connect the server to Azure Arc
& "$env:ProgramW6432\AzureConnectedMachineAgent\azcmagent.exe" connect `
    --resource-group "RG-Arc-Servers" `
    --tenant-id "<tenant-id>" `
    --location "westeurope" `
    --subscription-id "<subscription-id>" `
    --cloud "AzureCloud"
```

### Methode a grande echelle (plusieurs serveurs)

Pour inscrire de nombreux serveurs, utiliser un **Service Principal** :

```powershell
# Create a Service Principal for Arc onboarding
$sp = New-AzADServicePrincipal -DisplayName "Arc-Onboarding-SP"

# Assign the role
New-AzRoleAssignment -ObjectId $sp.Id `
    -RoleDefinitionName "Azure Connected Machine Onboarding" `
    -ResourceGroupName "RG-Arc-Servers"

# On each server, connect using the Service Principal
& "$env:ProgramW6432\AzureConnectedMachineAgent\azcmagent.exe" connect `
    --service-principal-id "<app-id>" `
    --service-principal-secret "<secret>" `
    --resource-group "RG-Arc-Servers" `
    --tenant-id "<tenant-id>" `
    --location "westeurope" `
    --subscription-id "<subscription-id>"
```

!!! tip "Deploiement GPO"

    Pour les environnements Active Directory, le script d'onboarding peut etre deploye
    via une GPO de demarrage ou une tache planifiee, en utilisant le Service Principal
    pour l'authentification automatique.

## Verifier l'etat de l'agent

```powershell
# Check agent status
& "$env:ProgramW6432\AzureConnectedMachineAgent\azcmagent.exe" show

# Check agent connectivity
& "$env:ProgramW6432\AzureConnectedMachineAgent\azcmagent.exe" check

# View agent logs
Get-Content "$env:ProgramData\AzureConnectedMachineAgent\Log\himds.log" -Tail 50
```

## Azure Policy pour serveurs Arc

Azure Policy permet d'evaluer et d'appliquer des configurations de conformite sur les serveurs Arc.

### Policies courantes pour Windows Server

| Policy | Description |
|--------|-------------|
| **Audit Windows machines that have not restarted within specified days** | Detecter les serveurs sans redemarrage recent |
| **Audit Windows machines on which Windows Defender Exploit Guard is not enabled** | Verifier la protection Exploit Guard |
| **Windows machines should have Log Analytics agent installed** | Assurer la presence de l'agent de monitoring |
| **Configure Windows Arc machines to run Azure Monitor Agent** | Deployer Azure Monitor Agent automatiquement |
| **Audit Windows machines that do not have specified Windows PowerShell execution policy** | Verifier la politique d'execution PowerShell |

### Assigner une policy

1. Portail Azure > **Policy** > **Definitions**
2. Rechercher la policy souhaitee
3. Cliquer sur **Assigner**
4. Selectionner le scope (abonnement ou resource group contenant les serveurs Arc)
5. Configurer les parametres
6. Creer l'assignation

## Extensions Arc

Les extensions ajoutent des fonctionnalites aux serveurs Arc :

| Extension | Description |
|-----------|-------------|
| **Azure Monitor Agent** | Collecte des metriques et logs vers Log Analytics |
| **Microsoft Defender for Cloud** | Protection contre les menaces |
| **Custom Script Extension** | Execution de scripts a distance |
| **Key Vault Extension** | Distribution de certificats depuis Azure Key Vault |
| **Azure Automation Hybrid Worker** | Execution de runbooks Azure Automation |

```powershell
# Install Azure Monitor Agent extension via Azure CLI
az connectedmachine extension create `
    --machine-name "SRV-DC01" `
    --resource-group "RG-Arc-Servers" `
    --name "AzureMonitorWindowsAgent" `
    --publisher "Microsoft.Azure.Monitor" `
    --type "AzureMonitorWindowsAgent" `
    --location "westeurope"
```

## Desinscription

```powershell
# Disconnect a server from Azure Arc
& "$env:ProgramW6432\AzureConnectedMachineAgent\azcmagent.exe" disconnect

# Uninstall the agent
msiexec /x "{00000000-0000-0000-0000-000000000000}" /qn
```

## Points cles a retenir

- Azure Arc projette les serveurs on-premises dans le portail Azure sans les migrer
- L'**Azure Connected Machine Agent** est le composant cle installe sur chaque serveur
- L'onboarding a grande echelle utilise un **Service Principal** deployable par GPO
- **Azure Policy** permet d'auditer et d'appliquer des standards de conformite
- Les **extensions** ajoutent des fonctionnalites (monitoring, securite, automation)
- Le serveur conserve son fonctionnement on-premises ; seule la gestion est etendue a Azure

## Pour aller plus loin

- [Azure Monitor](azure-monitor.md) pour la surveillance des serveurs Arc
- [Azure Backup](azure-backup.md) pour la sauvegarde cloud
- [Azure AD Connect](azure-ad-connect.md) pour l'identite hybride
